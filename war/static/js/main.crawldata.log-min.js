function crawlDataLog(option){if(option==null||option==undefined){option={tableId:"scheduledTaskLogTable",listTableId:"scheduledTaskLogList",PER_PAGE_ITEMS:10,ITEMS_COUNT:0,cur_page:0,webCrawlerId:null,siteId:siteId}}var init=function(){if(this.interval){clearInterval(this.interval)}this.v.cur_page=0;this.v.ITEMS_COUNT=0;this.v.PER_PAGE_ITEMS=10;this.updateCount()};var statistic=function(){showLoading($("#"+obj.v.tableId));jsonrpc.crawlDataLogService.statistic(function(result,exception,profile){removeLoading($("#"+obj.v.tableId));if(exception){return}var msg=result;if(msg){showInfo(nc.i18n("res.background.statistics"))}else{showInfo(nc.i18n("res.background.statistics.failure"))}},obj.v.webCrawlerId,obj.v.siteId)};var query=function(cur_page){var obj=this;var startIndex=cur_page*obj.v.PER_PAGE_ITEMS;moveAllTr(obj.v.tableId+" #"+obj.v.listTableId);queryLoading(obj.v.tableId+" #"+obj.v.listTableId);jsonrpc.crawlDataLogService.query(function(result,exception,profile){if(exception){removeLoading($("#"+obj.v.tableId));return}removeLoading($("#"+obj.v.tableId));moveAllTr(obj.v.tableId+" #"+obj.v.listTableId);var data=result;obj.showData(data)},obj.v.webCrawlerId,obj.v.siteId,startIndex,obj.v.PER_PAGE_ITEMS)};var updateCount=function(){var obj=this;jsonrpc.crawlDataLogService.count(function(result,exception,profile){obj.v.ITEMS_COUNT=result;obj.query(obj.v.cur_page);obj.initPagination(obj.v.cur_page);$("#"+obj.v.tableId).find("#URL_COUNT").html(obj.v.ITEMS_COUNT)},obj.v.webCrawlerId,obj.v.siteId)};var startTask=function(id){var obj=this;showLoading($("#"+obj.v.tableId));jsonrpc.scheduleService.startTask(function(result,exception,profile){if(exception){removeLoading($("#"+obj.v.tableId));return}var msg=result;if(msg){obj.updateCount();showInfo(nc.i18n("res.task.run.success"))}else{showInfo(nc.i18n("res.task.run.failure"))}removeLoading($("#"+obj.v.tableId))},obj.v.webCrawlerId,id)};var stopTask=function(id){var obj=this;showLoading($("#"+obj.v.tableId));jsonrpc.scheduleService.stopTask(function(result,exception,profile){if(exception){removeLoading($("#"+obj.v.tableId));return}var msg=result;if(msg){if(obj.interval){clearInterval(obj.interval)}obj.updateCount();showInfo(nc.i18n("res.task.stop.success"))}else{showInfo(nc.i18n("res.task.stop.failure"))}removeLoading($("#"+obj.v.tableId))},obj.v.webCrawlerId,id)};var showData=function(data){var obj=this;data=eval(data);var index=1;var hasRun=false;var key=""+obj.v.webCrawlerId;var crawlQueueHasImpl=crawlQueueHasImplMap.get(key);for(var i in data){if(isNaN(i)){continue}var rowData=data[i];var isRun=obj.addRow(index,rowData,crawlQueueHasImpl);hasRun=(hasRun||isRun);index++}if(hasRun){obj.autoRefresh()}$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find("tr:odd").css("background","#FFFFFF");$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find("tr:even").css("background","rgb(247, 247, 247)");$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find(".simplehighlight").hover(function(){$(this).children().addClass("datahighlight")},function(){$(this).children().removeClass("datahighlight")});$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find(".startTask").click(function(){var taskId=$(this).parent().find("#taskId").val();obj.startTask(taskId)});$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find(".stopTask").click(function(){var taskId=$(this).parent().find("#taskId").val();obj.stopTask(taskId)})};var autoRefresh=function(){obj.interval=setInterval(function(){obj.refresh(obj)},2000)};var refresh=function(obj){var ids="";$("#"+obj.v.tableId+" #"+obj.v.listTableId).find("tr[lang='"+obj.v.time+"']:not(:first)").each(function(){var isRun=$(this).find("#isRun").val();if(isRun=="true"){var taskId=$(this).find("#taskId").val();if(ids!=""){ids+=","}ids+=taskId}});if(ids!=""){jsonrpc.crawlDataLogService.query(function(result,exception,profile){if(exception){return}var data=result;if(data==null){return}data=eval(data);var hasRun=false;for(var i in data){if(isNaN(i)){continue}var isRun=obj.updateRow(data[i]);hasRun=(hasRun||isRun)}if(!hasRun){clearInterval(obj.interval)}$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find(".startTask").unbind("click");$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find(".startTask").click(function(){var taskId=$(this).parent().find("#taskId").val();obj.startTask(taskId)});$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find(".stopTask").click(function(){var taskId=$(this).parent().find("#taskId").val();obj.stopTask(taskId)})},obj.v.webCrawlerId,obj.v.siteId,ids)}else{clearInterval(obj.interval)}};var updateRow=function(rowData){var obj=this;var id=rowData.id;var urlQueueIn=rowData.urlQueueIn;var urlQueueOut=rowData.urlQueueOut;var urlQueueRunning=rowData.urlQueueRunning;var progressbar=0;var status="";if(urlQueueIn!=0&&urlQueueOut!=0){progressbar=urlQueueOut/urlQueueIn*100;if(progressbar>0){progressbar=Math.floor(progressbar)}}var isRun=false;if(rowData.finishDate!=null){status="<span class='label-info bg-green'>Finshed</span>";progressbar=100}else{if(rowData.status==0){status="<span class='label-info bg-black'>Stoped</span>"}else{isRun=true;status="<span class='label-info bg-blue'>Running</span>"}}var eleId="#tr_"+obj.v.time+"_"+id;var createDate=$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".createDate").text();createDate=new Date(createDate.replace(/-/g,"/"));var endDate=rowData.endDate;endDate=new Date(endDate.replace(/-/g,"/"));var costTime=obj.getDistanceTime(createDate,endDate);$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find("#isRun").val(isRun);$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".finishDate").text((rowData.finishDate==null?"":rowData.finishDate));$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".costTime").text(costTime);$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".urlQueueIn").text((urlQueueIn==null||urlQueueIn==0?"":urlQueueIn));$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".urlQueueOut").text((urlQueueOut==null||urlQueueOut==0?"":urlQueueOut));$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".urlQueueRunning").text((urlQueueRunning==null||urlQueueRunning==0?"":urlQueueRunning));$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".dataCount").text((rowData.dataCount==null||rowData.dataCount==0?"":rowData.dataCount));$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".status").html(status);var urlExceptionText=(rowData.urlException==null||rowData.urlException==0?"":rowData.urlException);urlExceptionText="<a href='javascript:void(0);' class='createTab' lang='CrawlUrlExceptionList.html'>"+urlExceptionText+"</a>";$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".urlException").html(urlExceptionText);$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".rulesError").text((rowData.rulesError==null||rowData.rulesError==0?"":rowData.rulesError));$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".deploySuccess").text((rowData.deploySuccess==null||rowData.deploySuccess==0?"":rowData.deploySuccess));var actionTd="&nbsp; &nbsp;";var key=""+obj.v.webCrawlerId;var crawlQueueHasImpl=crawlQueueHasImplMap.get(key);actionTd+='&nbsp;<input id="taskId" type="hidden" value="'+rowData.id+'"/> ';if(crawlQueueHasImpl){if(rowData.finishDate==null){if(rowData.status==0){$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".action").html(status);actionTd+='<input type="button" value="'+nc.i18n("res.task.run")+'" class="startTask jfk-button jfk-button-standard">&nbsp; '}else{actionTd+='<input type="button" value="'+nc.i18n("res.task.stop")+'" class="stopTask jfk-button jfk-button-standard">&nbsp; '}}}$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".action").html(actionTd);$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".createTab").unbind("click");$("#"+obj.v.tableId+" #"+obj.v.listTableId).find(eleId).find(".createTab").click(function(){crawlExceptionUrlList.v.crawlDataLogId=id;var url=$(this).attr("lang");createTab(url,nc.i18n("res.exception.url.list"))});$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find(eleId).find("#progressbar").progressbar({value:progressbar});var progressbarValue=$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find(eleId).find("#progressbar").find(".ui-progressbar-value");progressbarValue.removeClass("bg-blue");if(progressbar==100){progressbarValue.addClass("bg-green")}else{progressbarValue.addClass("bg-blue")}progressbarValue.css("display","");progressbarValue.html('<label style="padding-left: 50px;padding-right: 50px;">'+progressbar+"%</label>");return isRun};var addRow=function(index,rowData,crawlQueueHasImpl){var obj=this;var urlQueueIn=rowData.urlQueueIn;var urlQueueOut=rowData.urlQueueOut;var urlQueueRunning=rowData.urlQueueRunning;var progressbar=0;var status="";if(urlQueueIn!=0&&urlQueueOut!=0){progressbar=urlQueueOut/urlQueueIn*100;if(progressbar>0){progressbar=Math.floor(progressbar)}}var isRun=false;if(rowData.finishDate!=null){status="<span class='label-info bg-green'>Finshed</span>";progressbar=100}else{if(rowData.status==0){status="<span class='label-info bg-black'>Stoped</span>"}else{isRun=true;status="<span class='label-info bg-blue'>Running</span>"}}var siteName=getSiteName(rowData.siteId);siteName=(siteName==null?"":siteName);var taskName=rowData.taskName;if(taskName=="CRAWL"){taskName=nc.i18n("res.scheduledTasks.name1")}else{if(taskName=="URL_CHECK"){taskName=nc.i18n("res.scheduledTasks.name2")}else{if(taskName=="DEPOLY"){taskName=nc.i18n("res.scheduledTasks.name3")}else{if(taskName=="REMOVE_DATA"){taskName=nc.i18n("res.scheduledTasks.name4")}else{if(taskName=="UPDATE_URL"){taskName=nc.i18n("res.scheduledTasks.name5")}}}}}var createDate=rowData.createDate;createDate=new Date(createDate.replace(/-/g,"/"));var endDate=rowData.endDate;endDate=new Date(endDate.replace(/-/g,"/"));var costTime=obj.getDistanceTime(createDate,endDate);var newTr="<tr class='simplehighlight' id='tr_"+obj.v.time+"_"+rowData.id+"' lang='"+obj.v.time+"'>";newTr+="<td nowrap>"+index+"<input type='hidden' id='isRun' value='"+isRun+"'/></td>";newTr+="<td nowrap>&nbsp; "+siteName+"&nbsp; &nbsp; </td>";newTr+="<td nowrap>&nbsp; "+taskName+"&nbsp; &nbsp; </td>";newTr+="<td nowrap>&nbsp; "+rowData.rate+"&nbsp; &nbsp; </td>";newTr+="<td nowrap class='createDate'>"+rowData.createDate+"</td>";newTr+="<td nowrap class='finishDate'>"+(rowData.finishDate==null?"":rowData.finishDate)+"</td>";newTr+="<td nowrap class='costTime'>"+costTime+"</td>";newTr+="<td nowrap class='urlQueueIn'>"+(urlQueueIn==null||urlQueueIn==0?"":urlQueueIn)+"</td>";newTr+="<td nowrap class='urlQueueOut'>"+(urlQueueOut==null||urlQueueOut==0?"":urlQueueOut)+"</td>";newTr+="<td nowrap class='urlQueueRunning'>"+(urlQueueRunning==null||urlQueueRunning==0?"":urlQueueRunning)+"</td>";var urlExceptionText=(rowData.urlException==null||rowData.urlException==0?"":rowData.urlException);urlExceptionText="<a href='javascript:void(0);' class='createTab' lang='CrawlUrlExceptionList.html'>"+urlExceptionText+"</a>";newTr+="<td nowrap class='urlException'>"+urlExceptionText+"</td>";newTr+="<td nowrap class='rulesError'>"+(rowData.rulesError==null||rowData.rulesError==0?"":rowData.rulesError)+"</td>";newTr+="<td nowrap class='dataCount'>"+(rowData.dataCount==null||rowData.dataCount==0?"":rowData.dataCount)+"</td>";newTr+="<td nowrap class='deploySuccess'>"+(rowData.deploySuccess==null||rowData.deploySuccess==0?"":rowData.deploySuccess)+"</td>";newTr+="<td nowrap class='status'>"+status+"</td>";newTr+="<td nowrap><div id='progressbar'></div></td>";if(rowData.finishDate==null){newTr+='<td nowrap class="action">';newTr+='<input id="taskId" type="hidden" value="'+rowData.id+'"/>';if(crawlQueueHasImpl){if(rowData.status==0){newTr+='<input type="button" value="'+nc.i18n("res.task.run")+'" class="startTask jfk-button jfk-button-standard">'}else{newTr+='<input type="button" value="'+nc.i18n("res.task.stop")+'" class="stopTask jfk-button jfk-button-standard">'}}newTr+="</td>"}else{newTr+='<td nowrap class="action">&nbsp; &nbsp; </td>'}newTr+="</tr>";var newTrObj=$(newTr);newTrObj.find(".createTab").unbind("click");newTrObj.find(".createTab").click(function(){crawlExceptionUrlList.v.crawlDataLogId=rowData.id;var url=$(this).attr("lang");createTab(url,nc.i18n("res.exception.url.list"))});newTrObj.appendTo("#"+obj.v.tableId+" #"+obj.v.listTableId);$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find("tr_"+obj.v.time+"_"+rowData.id).find("#progressbar").progressbar({value:progressbar});var progressbarValue=$("#"+obj.v.tableId).find("#"+obj.v.listTableId).find("tr_"+obj.v.time+"_"+rowData.id).find("#progressbar").find(".ui-progressbar-value");if(progressbar==100){progressbarValue.addClass("bg-green")}else{progressbarValue.addClass("bg-blue")}progressbarValue.css("display","");progressbarValue.html('<label style="padding-left: 50px;padding-right: 50px;">'+progressbar+"%</label>");return isRun};var initPagination=function(cur_page){var obj=this;$("#"+obj.v.tableId).find("#Pagination").pagination(obj.v.ITEMS_COUNT,{num_edge_entries:2,num_display_entries:8,current_page:cur_page,callback:obj.pageselectCallback,items_per_page:obj.v.PER_PAGE_ITEMS,prev_text:nc.i18n("res.page.prev"),next_text:nc.i18n("res.page.next")})};var getDistanceTime=function(date1,date2){var day=0;var hour=0;var min=0;var sec=0;var time1=date1.getTime();var time2=date2.getTime();var diff;if(time1<time2){diff=time2-time1}else{diff=time1-time2}var result="";var hasMore=false;day=diff/(24*60*60*1000);day=Math.floor(day);if(day>0){result+=day+"天";hasMore=true}hour=(diff/(60*60*1000)-day*24);hour=Math.floor(hour);if(hour>0||hasMore){result+=hour+"小时"}min=((diff/(60*1000))-day*24*60-hour*60);min=Math.floor(min);if(min>0||hasMore){result+=min+"分"}sec=(diff/1000-day*24*60*60-hour*60*60-min*60);sec=Math.floor(sec);if(sec>0){result+=(sec.toString())+"秒"}else{if(!hasMore){var secFloat=((diff/1000)-day*24*60*60-hour*60*60-min*60);secFloat=Math.floor(secFloat);result+=(secFloat.toString())+"秒"}}return result};var obj=this;var pageselectCallback=function(page_index,jq){obj.v.cur_page=page_index;showLoading($("#"+obj.v.tableId));obj.query(obj.v.cur_page);return false};this.v=option;this.init=init;this.query=query;this.updateCount=updateCount;this.startTask=startTask;this.stopTask=stopTask;this.showData=showData;this.initPagination=initPagination;this.pageselectCallback=pageselectCallback;this.getDistanceTime=getDistanceTime;this.addRow=addRow;this.updateRow=updateRow;this.autoRefresh=autoRefresh;this.refresh=refresh;this.statistic=statistic;var myDate=new Date();this.v.time=myDate.getTime()};
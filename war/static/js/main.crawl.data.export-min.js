var crawlDataExport={v:{tableId:"crawlDataExportTable",formId:"crawlDataExportForm",webCrawlerId:null,siteId:null,crawlRules:null,api:null},fn:{init:function(){if(crawlDataExport.v.siteId==null){showInfo(nc.i18n("res.site.invalid.refresh"));return}jsonrpc.crawlDataExportService.getApi(function(result,exception,profile){result="("+result+")";result=eval(result);var apiExportData=result.apiExportData;crawlDataExport.v.api=apiExportData;apiExportData=apiExportData+"&type=json";$("#"+crawlDataExport.v.tableId).find("#apiExportData").html(apiExportData+"<a href='"+apiExportData+"' target='_blank'>"+nc.i18n("res.view")+"</a>");removeLoading($("#"+crawlDataExport.v.tableId))},crawlDataExport.v.webCrawlerId,crawlDataExport.v.siteId);fillRulesVer(crawlDataExport.v.tableId,"crawlRulesVerId",true,null,function(){var crawlRulesVerIdObj=$("#"+crawlDataExport.v.tableId+" #crawlRulesVerId option:eq(1)");if(crawlRulesVerIdObj!=null){crawlRulesVerIdObj.attr("selected","selected");crawlDataExport.fn.changeRulesVer(crawlRulesVerIdObj.val())}});$("#"+crawlDataExport.v.tableId+" input[type=radio][name=type]").change(function(){var type=$("#"+crawlDataExport.v.tableId+" input[type=radio][name=type]:checked").val();var api=crawlDataExport.v.api+"&type="+type;$("#"+crawlDataExport.v.tableId).find("#apiExportData").html(api+"<a href='"+api+"' target='_blank'>"+nc.i18n("res.view")+"</a>");crawlDataExport.fn.initMap()})},save:function(){var c=$("#"+crawlDataExport.v.tableId+" input[type=radio][name=type]:checked").val();var b=$("#"+crawlDataExport.v.tableId+" #crawlRulesVerId").val();var d={};$("#"+crawlDataExport.v.formId).find(".rules").find("li").each(function(){var e=$(this).find(".name").text();var f="";if("json"==c){f=$(this).find("input[name=map]").val()}else{f=$(this).find("select[name=mapSelect]").val()}d[e]=f});var a=$.toJSON(d);showLoading($("#"+crawlDataExport.v.tableId));jsonrpc.crawlDataExportService.save(function(e,f,g){removeLoading($("#"+crawlDataExport.v.tableId));var h=e;if(h){showInfo(nc.i18n("res.save.success"))}else{showInfo(nc.i18n("res.save.failure"))}},crawlDataExport.v.webCrawlerId,crawlDataExport.v.siteId,b,c,a)},changeRulesVer:function(id){$("#"+crawlDataExport.v.formId).find(".rules").empty();if(id==null||id===""){return}jsonrpc.crawlRulesService.query(function(result,exception,profile){var data=result;data=eval(data);crawlDataExport.v.crawlRules=data;crawlDataExport.fn.initMap()},crawlDataExport.v.webCrawlerId,crawlDataExport.v.siteId,id)},initMap:function(){var type=$("#"+crawlDataExport.v.tableId+" input[type=radio][name=type]:checked").val();jsonrpc.crawlDataExportService.query(function(result,exception,profile){var data=result;data=eval(data);crawlDataExport.fn.initMapHtml(type,data)},crawlDataExport.v.webCrawlerId,crawlDataExport.v.siteId,type)},initMapHtml:function(h,l){$("#"+crawlDataExport.v.formId).find(".rules").empty();var d=crawlDataExport.v.crawlRules;if("json"==h){for(var e in d){if(isNaN(e)){continue}var a=d[e]["name"];if(d[e]["labelType"]=="2"||d[e]["labelType"]=="4"||d[e]["isOffset"]=="true"||d[e]["isTemp"]=="true"){continue}var g="item_"+e;var b="<li class='"+g+"'><span class='name'>"+a+"</span><span class='map'><input type='text' name='map'/></span></li>";$("#"+crawlDataExport.v.formId).find(".rules").append(b);var k="";for(var c in l){if(isNaN(c)){continue}if(l[c]["name"]==a){k=l[c]["value"];break}}$("#"+crawlDataExport.v.formId).find(".rules").find("."+g).find("input[name=map]").val(k)}}else{var f="<select name='mapSelect'><option></option><option value='title'>title</option><option value='link'>link</option><option value='description'>description</option><option value='pubDate'>pubDate</option><option value='author'>author</option></select>";for(var e in d){if(isNaN(e)){continue}var a=d[e]["name"];if(d[e]["labelType"]=="2"||d[e]["labelType"]=="4"||d[e]["isOffset"]=="true"||d[e]["isTemp"]=="true"){continue}var g="item_"+e;var b="<li class='"+g+"'><span class='name'>"+a+"</span><span class='map'>"+f+"</span></li>";$("#"+crawlDataExport.v.formId).find(".rules").append(b);var k="";for(var c in l){if(isNaN(c)){continue}if(l[c]["name"]==a){k=l[c]["value"];break}}$("#"+crawlDataExport.v.formId).find(".rules").find("."+g).find("select[name=mapSelect]").val(k)}}}}};